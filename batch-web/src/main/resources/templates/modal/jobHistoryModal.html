<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤í–‰ ì´ë ¥ ëª¨ë‹¬</title>
</head>
<body>

<th:block th:fragment="jobHistoryModal">
  <!-- grid.js css -->
  <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />

  <div id="jobHistoryModal" class="modal">
    <div class="modal-content modal-lg">
      <span class="close">&times;</span>

      <h2>ì‹¤í–‰ ì´ë ¥</h2>
      <form class="job-form" onsubmit="return false;">
        <div class="form-group">
          <label for="jobNameForJmm">ì‘ì—… ì´ë¦„</label>
          <input type="text" id="jobNameForJmm" name="jobName" disabled>
        </div>

        <div class="card">
          <div class="card-header">ì´ë ¥ ëª©ë¡</div>
          <div class="card-body" style="padding: 0;">
            <div id="historyList" style="overflow-x: auto;"></div>
          </div>
        </div>

        <div class="form-buttons">
          <button type="button" class="cancel-btn">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- grid.js ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
  <script>
    var grid;
    var jobName;

    document.addEventListener("DOMContentLoaded", function() {

        // grid ì„¤ì •
        grid = new gridjs.Grid({
            width: '1000px',   // ê°€ë¡œ ìŠ¤í¬ë¡¤ì„ ì‚¬ìš©í•  ê²ƒì´ë¯€ë¡œ ì‚¬ì´ì¦ˆ ê³ ì •
            autoWidth: false,  // ê·¸ë¦¬ë“œë¥¼ ìë™ìœ¼ë¡œ ë§ì¶”ëŠ” ê¸°ëŠ¥ ë„ê¸°
            columns: [
              {id: "jobExecutionId", name: "ë²ˆí˜¸", width: "100px"},
              {id: "jobName", name: "ì‘ì—…ëª…", width: "150px"},
              {
                id: "startTime",
                name: "ì‹œì‘ì‹œê°„",
                formatter: (cell) => dateFormat(cell),
                width: "200px"
              },
              {
                id: "endTime",
                name: "ì¢…ë£Œì‹œê°„",
                formatter: (cell) => dateFormat(cell),
                width: "200px"
              },
              {id: "status", name: "ì‹¤í–‰ìƒíƒœ", width: "150px"},
              {id: "exitCode", name: "ì¢…ë£Œì½”ë“œ", width: "150px"},
              {id: "exitMessage", name: "ì¢…ë£Œë©”ì„¸ì§€"},
            ],
            pagination: {
              enabled: true,
              limit: 5,
              server: {
                url: (prev, page, limit) => {
                  return `/api/job/history/${jobName}?page=${page + 1}&pageSize=${limit}`;
                }
              }
            },
            server: {
              url: (prev, page, limit) => {
                return `/api/job/history/${jobName}?page=${page + 1}&pageSize=${limit}`;
              },
              then: data => data.jobHistoryList.map(item => [
                item.jobExecutionId,
                item.jobName,
                item.startTime,
                item.endTime,
                item.status,
                item.exitCode,
                item.exitMessage,
              ]),
              total: data => data.totalElements
            },
            language: {
              search: {
                'placeholder': 'ğŸ” ê²€ìƒ‰ì¤‘...'
              },
              pagination: {
                'previous': 'â¬…ï¸',
                'next': 'â¡ï¸',
                'showing': 'ğŸ˜ƒ ë²ˆí˜¸',
                'to': '~',
                'of': ', ì´',
                'results': () => 'ê±´'
              },
              loading: 'Loading...',
              noRecordsFound: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
              error: 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.'
            },
       }).render(document.getElementById("historyList"));


       // grid row ì„ íƒ ì´ë²¤íŠ¸
       grid.on('rowClick', (...args) => {
           //const orderId = args[1]._cells[0].data;
           //showOrderDetailModal(orderId);

           alert('hello');
       });
    });

    // ì‹¤í–‰ ì´ë ¥ ëª¨ë‹¬ ì´ˆê¸° ì„¤ì •
    function setupJobHistoryModal() {
      const modal = document.getElementById('jobHistoryModal');
      const form = modal.querySelector(".job-form");
      const closeBtn = modal.querySelector(".close");
      const cancelBtn = modal.querySelector(".cancel-btn");

      function closeModal() {
        modal.style.display = "none";
        form.reset();
      };

      closeBtn.onclick = closeModal;
      cancelBtn.onclick = closeModal;

      // ëª¨ë‹¬ ë°–ì„ í´ë¦­í–ˆì„ ë•Œ ëª¨ë‹¬ ì¢…ë£Œ
      window.onclick = function(event) {
        if (event.target === modal) {
          closeModal();
        }
      };
    }

    // ì‹¤í–‰ ì´ë ¥ ëª¨ë‹¬ ì—´ê¸°
    function openJobHistoryModal(targetJobName) {
      const modal = document.getElementById('jobHistoryModal');
      modal.style.display = "block";

      const form = modal.querySelector(".job-form");
      form.jobName.value = targetJobName;
      jobName = targetJobName;

      searchJobHistory();
    }

    // ì‹¤í–‰ ì´ë ¥ ì¡°íšŒ
    function searchJobHistory() {
        grid.updateConfig({
          server: {
            url: (prev, page, limit) => {
              return `/api/job/history/${jobName}?page=${page + 1}&pageSize=${limit}`;
            },
            then: data => data.jobHistoryList.map(item => [
              item.jobExecutionId,
              item.jobName,
              item.startTime,
              item.endTime,
              item.status,
              item.exitCode,
              item.exitMessage,
            ]),
            total: data => data.totalElements
          }
        }).forceRender();
    }

    function dateFormat(dataArray) {
      if(dataArray.length < 6) return '-';

      const year = dataArray[0];
      const month = String(dataArray[1]).padStart(2, '0');
      const day = String(dataArray[2]).padStart(2, '0');

      const hour = String(dataArray[3]).padStart(2, '0');
      const minute = String(dataArray[4]).padStart(2, '0');
      const second = String(dataArray[5]).padStart(2, '0');
      return year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second;
    }
  </script>

</th:block>

</body>
</html>