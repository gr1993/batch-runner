<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>

    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/map.css?v=3">
</head>
<body>
    <div class="sidebar">
        <h2>ğŸ›  ê´€ë¦¬ì</h2>
        <div class="nav-item active" onclick="location.href='/';">ê´€ì‹¬ ì •ë¥˜ì†Œ ë³´ê¸°</div>
        <div class="nav-item" onclick="location.href='/job';">ì‘ì—… ê´€ë¦¬</div>
    </div>

    <div class="content">
        <h1>ê´€ì‹¬ ì •ë¥˜ì†Œ ë³´ê¸°</h1>

        <div class="main">
            <div id="map"></div>
            <div class="info-panel hidden" id="info-panel">
                <button class="close-btn" onclick="hideInfoPanel()">Ã—</button>
                <div id="info-content">
                    <h3 id="stop-title"></h3>
                    <hr/>
                    <div id="route-badges" class="badge-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- appkey : JavaScript í‚¤ (ë˜í•œ ì›¹ í”Œë«í¼ì— ì‚¬ì´íŠ¸ ë„ë©”ì¸ë„ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•¨) -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2b9896e6862ec303926139e843ab9a4e&libraries=clusterer"></script>
    <script type="text/javascript" src="/js/kakaoMapUtils.js"></script>
    <script type="text/javascript" src="/js/httpClient.js"></script>
    <script>
        var map;
        var minLevel = 6;  // ì§€ë„ì— í´ëŸ¬ìŠ¤í„° í•  ìµœì†Œ ì§€ë„ ë ˆë²¨
        var currentPolyline = null;  // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸ (ì´ì „ í´ë¦¬ë¼ì¸ ì¶”ì )
        let currentRouteId = null;  // ì„ íƒëœ ë…¸ì„  ID

        document.addEventListener("DOMContentLoaded", function() {
            // ì§€ë„ ìƒì„±
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(33.450701, 126.570667),
                level: 3
            };
            map = new kakao.maps.Map(container, options);

            // ë¸Œë¼ìš°ì €ì˜ ìœ„ì¹˜ ì •ë³´ê¸°ëŠ¥ ì—¬ë¶€ í™•ì¸
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getCurrentPos);
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }

            // í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
            kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                // var position = mouseEvent.latLng;
            });

            // ì¤Œ ë³€ê²½ ì´ë²¤íŠ¸ ë“±ë¡
            kakao.maps.event.addListener(map, 'zoom_changed', function () {
                const zoomLevel = map.getLevel();
                if (currentPolyline) {
                    if (zoomLevel >= minLevel) {
                        currentPolyline.setMap(null); // ìˆ¨ê¹€
                    } else {
                        currentPolyline.setMap(map);  // ë‹¤ì‹œ í‘œì‹œ
                    }
                }
            });

            // ëª¨ë“  ì •ë¥˜ì†Œ ì •ë³´ ì¡°íšŒ
            loadAllBusStop();
        });

        // ì‚¬ìš©ìì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ ê²½ìš° í˜¸ì¶œ
        function getCurrentPos(position) {
            // í˜„ì¬ ìœ„ì¹˜ì˜ ìœ„ë„, ê²½ë„
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;

            var position = new kakao.maps.LatLng(lat, lon); // ë§ˆì»¤ ìœ„ì¹˜ (í˜„ì¬ ìœ„ì¹˜)
            var marker = createMarker(position);
            marker.setMap(map);

            // ì¢Œí‘œë¡œ ì§€ë„ ì´ë™
            map.setCenter(position);
        }

        // ëª¨ë“  ì •ë¥˜ì†Œ ì •ë³´ ì¡°íšŒ (4ë§Œ ê°œì˜ ì •ë¥˜ì†Œ ë§ˆì»¤ëŠ” ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•˜ì—¬ clustererë¥¼ ì‚¬ìš©
        function loadAllBusStop() {
            get('/api/map/stop', function(busStopData) {

                const clusterer = new kakao.maps.MarkerClusterer({
                    map: map,
                    averageCenter: true,
                    minLevel: minLevel
                });

                const markers = busStopData.map(stop => {
                    var marker = createMarker(new kakao.maps.LatLng(stop.lat, stop.lng), 'stop', stop.nodeName);

                    kakao.maps.event.addListener(marker, 'click', function() {
                        showBusStopInfo(stop);
                    });

                    return marker;
                });

                clusterer.addMarkers(markers);
            });
        }

        function showBusStopInfo(stop) {
            const title = document.getElementById('stop-title');
            title.textContent = `(${stop.arsId}) ${stop.nodeName}`;

            // í•´ë‹¹ ì •ë¥˜ì†Œì˜ ë…¸ì„  ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
            get(`/api/map/stop/${stop.nodeId}/routes`, function(routeList) {
                const badgeContainer = document.getElementById('route-badges');

                badgeContainer.innerHTML = routeList.map(route => `
                    <span class="route-badge" onclick="clickRoute('${route.routeId}')">${route.routeName}</span>
                `).join('');

                // ì •í‘œ íŒ¨ë„ í‘œì¶œ
                showInfoPanel();
            });
        }

        // ì •ë³´íŒ¨ë„ì—ì„œ ë…¸ì„  ì„ íƒ
        function clickRoute(routeId) {
            // ê°™ì€ ë…¸ì„  ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë¬´ì‹œ
            if (routeId === currentRouteId) return;

            currentRouteId = routeId;

            // ì´ì „ í´ë¦¬ë¼ì¸ ì œê±°
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }

            // ë…¸ì„ ì— ì†í•œ ì •ë¥˜ì¥ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
            get(`/api/map/routes/${routeId}/stops`, function(stopList) {
                const linePath = stopList.map(stop => new kakao.maps.LatLng(stop.lat, stop.lng));
                const polyline = createPolyline(linePath);
                polyline.setMap(map);

                const zoomLevel = map.getLevel();
                if (zoomLevel < minLevel) {
                    polyline.setMap(map);
                }

                currentPolyline = polyline;

                // ìˆœì„œ í‘œì‹œ (CustomOverlayë¡œ ê° ë§ˆì»¤ ìœ„ì— ë²ˆí˜¸ í‘œì‹œ)
                linePath.forEach((position, index) => {
                    const label = new kakao.maps.CustomOverlay({
                        position: position,
                        content: `<div class="marker-label">${index + 1}</div>`,
                        yAnchor: 1
                    });

                    label.setMap(map);
                });
            });
        }

        // ì •ë³´ íŒ¨ë„ ì—´ê¸°
        function showInfoPanel() {
            document.getElementById('info-panel').classList.remove('hidden');
        }

        // ì •ë³´ íŒ¨ë„ ë‹«ê¸°
        function hideInfoPanel() {
            document.getElementById('info-panel').classList.add('hidden');
        }
    </script>

</body>
</html>

