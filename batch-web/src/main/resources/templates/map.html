<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>

    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/map.css?v=5">
</head>
<body>
    <div class="sidebar">
        <h2>ğŸ›  ê´€ë¦¬ì</h2>
        <div class="nav-item active" onclick="location.href='/';">ê´€ì‹¬ ì •ë¥˜ì†Œ ë³´ê¸°</div>
        <div class="nav-item" onclick="location.href='/job';">ì‘ì—… ê´€ë¦¬</div>
    </div>

    <div class="content">
        <h1>ê´€ì‹¬ ì •ë¥˜ì†Œ ë³´ê¸°</h1>

        <div class="favorites-bar">
            <h3>â­ ì¦ê²¨ì°¾ê¸° ëª©ë¡</h3>
            <ul id="favorites-list" class="favorites-list"></ul>
        </div>


        <div class="main">
            <!-- ë§ˆì»¤ í‘œì‹œ ì»¨íŠ¸ë¡¤ -->
            <div class="map-control">
                <button id="marker-toggle-btn" class="marker-toggle active" onclick="toggleMarkersButton()">
                    <img src="/image/bus-stop.png" alt="ë²„ìŠ¤ ë§ˆì»¤" class="marker-icon">
                    <span>ì •ë¥˜ì†Œ</span>
                </button>
            </div>

            <div id="map"></div>

            <!-- ì •ë¥˜ì†Œ ì •ë³´ íŒ¨ë„ UI -->
            <div class="info-panel hidden" id="info-panel">
                <button class="close-btn" onclick="hideInfoPanel()">Ã—</button>

                <div id="info-content">
                    <div style="display: flex; align-items: center;">
                        <svg id="favorite-icon" class="favorite-icon" onclick="toggleFavorite()" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="gold" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon class="star-shape" points="12 2 15 8.5 22 9.3 17 14 18.5 21 12 17.8 5.5 21 7 14 2 9.3 9 8.5 12 2"/>
                        </svg>
                        <h3 id="stop-title" style="margin-left: 8px;"></h3>
                    </div>
                    <hr/>
                    <div id="route-badges" class="badge-container"></div>
                    <div  id="busArrivalsContainer" class="bus-arrivals"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- appkey : JavaScript í‚¤ (ë˜í•œ ì›¹ í”Œë«í¼ì— ì‚¬ì´íŠ¸ ë„ë©”ì¸ë„ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•¨) -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2b9896e6862ec303926139e843ab9a4e&libraries=clusterer"></script>
    <script type="text/javascript" src="/js/kakaoMapUtils.js?v=1"></script>
    <script type="text/javascript" src="/js/httpClient.js?v=2"></script>
    <script>
        var map;
        var minLevel = 6;  // ì§€ë„ì— í´ëŸ¬ìŠ¤í„° í•  ìµœì†Œ ì§€ë„ ë ˆë²¨
        var clusterer;
        var currentPolyline = null;  // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸ (ì´ì „ í´ë¦¬ë¼ì¸ ì¶”ì )
        let currentPolylineLabel = [];
        var currentRouteId = null;  // ì„ íƒëœ ë…¸ì„  ID

        var currentStopInfo;
        var currentStopMarker;
        var favoriteStopInfos = {};
        var stopMarkers = [];
        var busMarkers = [];
        var markersVisible = true;

        document.addEventListener("DOMContentLoaded", function() {
            // ì§€ë„ ìƒì„±
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(33.450701, 126.570667),
                level: 3
            };
            map = new kakao.maps.Map(container, options);

            // ë¸Œë¼ìš°ì €ì˜ ìœ„ì¹˜ ì •ë³´ê¸°ëŠ¥ ì—¬ë¶€ í™•ì¸
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getCurrentPos);
            } else {
                alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }

            // í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
            kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                // var position = mouseEvent.latLng;
            });

            // ì¤Œ ë³€ê²½ ì´ë²¤íŠ¸ ë“±ë¡
            kakao.maps.event.addListener(map, 'zoom_changed', function () {
                const zoomLevel = map.getLevel();
                if (currentPolyline) {
                    if (zoomLevel >= minLevel) {
                        currentPolyline.setMap(null); // ìˆ¨ê¹€
                    } else {
                        currentPolyline.setMap(map);  // ë‹¤ì‹œ í‘œì‹œ
                    }
                }
            });

            // ëª¨ë“  ì •ë¥˜ì†Œ ì •ë³´ ì¡°íšŒ
            loadAllBusStop();

            // ì¦ê²¨ì°¾ê¸° ëª©ë¡ í‘œì‹œí•˜ê¸°
            showFavoriteStopList();

            // ë²„ìŠ¤ ìœ„ì¹˜ SSE ì´ë²¤íŠ¸ ë“±ë¡
            setSseEvent();
        });

        // ì‚¬ìš©ìì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ ê²½ìš° í˜¸ì¶œ
        function getCurrentPos(position) {
            // í˜„ì¬ ìœ„ì¹˜ì˜ ìœ„ë„, ê²½ë„
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;

            var position = new kakao.maps.LatLng(lat, lon); // ë§ˆì»¤ ìœ„ì¹˜ (í˜„ì¬ ìœ„ì¹˜)
            var marker = createMarker(position);
            marker.setMap(map);

            // ì¢Œí‘œë¡œ ì§€ë„ ì´ë™
            map.setCenter(position);
        }

        // ëª¨ë“  ì •ë¥˜ì†Œ ì •ë³´ ì¡°íšŒ (4ë§Œ ê°œì˜ ì •ë¥˜ì†Œ ë§ˆì»¤ëŠ” ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•˜ì—¬ clustererë¥¼ ì‚¬ìš©
        function loadAllBusStop() {
            get('/api/map/stop', function(busStopData) {

                clusterer = new kakao.maps.MarkerClusterer({
                    map: map,
                    averageCenter: true,
                    minLevel: minLevel
                });

                const markers = chunkedAddMarkersToClusterer(busStopData);
            });
        }

        // 4ë§Œ ê°œ ì´ìƒ ë§ˆì»¤ë¥¼ í•œë²ˆì— ìƒì„±í•˜ë©´ ì˜¤ë˜ ê±¸ë¦¬ë¯€ë¡œ 500ê°œì”© ë‚˜ëˆ„ì–´ ìƒì„± (ì§€ë„ UI ë©ˆì¶¤ ë°©ì§€)
        function chunkedAddMarkersToClusterer(data, chunkSize = 500) {
            let i = 0;

            function processChunk() {
                const end = Math.min(i + chunkSize, data.length);
                const chunk = data.slice(i, end).map(stop => {
                    var marker = createMarker(new kakao.maps.LatLng(stop.lat, stop.lng), 'stop', stop.nodeName);
                    stopMarkers.push(marker);

                    kakao.maps.event.addListener(marker, 'click', function() {
                        showBusStopInfo(stop);
                    });

                    return marker;
                });

                clusterer.addMarkers(chunk);
                i = end;

                if (i < data.length) {
                    setTimeout(processChunk, 0); // ë‹¤ìŒ chunk
                }
            }

            processChunk();
        }

        function showBusStopInfo(stop) {
            currentStopInfo = stop;

            const title = document.getElementById('stop-title');
            title.textContent = `(${stop.arsId}) ${stop.nodeName}`;

            // í˜„ì¬ ì •ë¥˜ì¥ í‘œì‹œ í™”ì‚´í‘œ ë§ˆì»¤
            if (currentStopMarker) {
                currentStopMarker.setMap(null);
            }
            var marker = createMarker(new kakao.maps.LatLng(stop.lat, stop.lng), 'downArrow');
            marker.setMap(map);
            currentStopMarker = marker;

            // ì¦ê²¨ì°¾ê¸° ì •ë¥˜ì†Œì¸ì§€ ì—¬ë¶€ ì²´í¬ í›„ í‘œì‹œ
            const icon = document.getElementById('favorite-icon');
            if (favoriteStopInfos[stop.nodeId]) {
                icon.classList.add('favorited');
            } else {
                icon.classList.remove('favorited');
            }

            // í•´ë‹¹ ì •ë¥˜ì†Œì˜ ë…¸ì„  ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
            get(`/api/map/stop/${stop.nodeId}/routes`, function(routeList) {
                const badgeContainer = document.getElementById('route-badges');

                badgeContainer.innerHTML = routeList.map(route => `
                    <span
                        class="route-badge"
                        onclick="clickRoute(this)"
                        data-routeId="${route.routeId}"
                        data-nodeId="${stop.nodeId}"
                        data-nodeSeq="${route.nodeSeq}"
                    >${route.routeName}</span>
                `).join('');

                // ì •í‘œ íŒ¨ë„ í‘œì¶œ
                showInfoPanel();
            });
        }

        // ì •ë³´íŒ¨ë„ì—ì„œ ë…¸ì„  ì„ íƒ
        function clickRoute(clickedElement) {
            var routeId = clickedElement.getAttribute('data-routeId');
            var nodeId = clickedElement.getAttribute('data-nodeId');
            var nodeSeq = clickedElement.getAttribute('data-nodeSeq');

            // ê°™ì€ ë…¸ì„  ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë¬´ì‹œ
            if (routeId === currentRouteId) return;
            currentRouteId = routeId;

            document.querySelectorAll(".route-badge").forEach(el => {
                el.classList.remove("selected");
            });
            clickedElement.classList.add("selected");

            // í•´ë‹¹ ë…¸ì„ ì˜ í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
            drawPolylineByRoute(routeId);

            // í•´ë‹¹ ë…¸ì„ ì˜ ë²„ìŠ¤ ë„ì°© ì •ë³´ í‘œì‹œ
            setBusArrivalInfo(nodeId, routeId, nodeSeq);
        }

        // ì„ íƒëœ ì •ë¥˜ì¥ì˜ ë…¸ì„  ë¼ì¸ ê·¸ë¦¬ê¸°
        function drawPolylineByRoute(routeId) {

            // ì´ì „ í´ë¦¬ë¼ì¸ ì œê±°
            if (currentPolyline) {
                currentPolyline.setMap(null);
                currentPolyline = null;
            }
            // ì´ì „ í´ë¦¬ë¼ì¸ì˜ ë¼ë²¨ë“¤ ì œê±°
            currentPolylineLabel.forEach(label => label.setMap(null));
            currentPolylineLabel = [];

            // ë…¸ì„ ì— ì†í•œ ì •ë¥˜ì¥ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
            get(`/api/map/routes/${routeId}/stops`, function(stopList) {
                const linePath = stopList.map(stop => new kakao.maps.LatLng(stop.lat, stop.lng));
                const polyline = createPolyline(linePath);
                polyline.setMap(map);

                const zoomLevel = map.getLevel();
                if (zoomLevel < minLevel) {
                    polyline.setMap(map);
                }

                currentPolyline = polyline;

                // ìˆœì„œ í‘œì‹œ (CustomOverlayë¡œ ê° ë§ˆì»¤ ìœ„ì— ë²ˆí˜¸ í‘œì‹œ)
                linePath.forEach((position, index) => {
                    const label = new kakao.maps.CustomOverlay({
                        position: position,
                        content: `<div class="marker-label">${index + 1}</div>`,
                        yAnchor: 1
                    });

                    label.setMap(map);
                    currentPolylineLabel.push(label);
                });
            });
        }

        // í•´ë‹¹ ë…¸ì„ ì˜ ë²„ìŠ¤ ë„ì°© ì •ë³´ í‘œì‹œ
        function setBusArrivalInfo(nodeId, routeId, nodeSeq) {
            const container = document.getElementById('busArrivalsContainer');

            get(`/api/map/stop/arrival?nodeId=${nodeId}&routeId=${routeId}&nodeSeq=${nodeSeq}`, function(busArrivalInfoList) {
                container.innerHTML = busArrivalInfoList.map((arrivalInfo) => `
                    <div class="bus-card">
                        <div class="bus-number">${arrivalInfo.busRouteAbrv}</div>
                        <div class="arrival-info">${arrivalInfo.arrmsg1}</div>
                    </div>
                `).join('');
            });
        }

        // ì •ë³´ íŒ¨ë„ ì—´ê¸°
        function showInfoPanel() {
            document.getElementById('info-panel').classList.remove('hidden');
        }

        // ì •ë³´ íŒ¨ë„ ë‹«ê¸°
        function hideInfoPanel() {
            document.getElementById('info-panel').classList.add('hidden');
        }

        // ì •ë¥˜ì†Œ ì¦ê²¨ì°¾ê¸° ì´ë²¤íŠ¸
        function toggleFavorite() {
            const icon = document.getElementById('favorite-icon');
            const isFavorited = icon.classList.toggle('favorited');

            if (isFavorited) {
                addToFavorites();
            } else {
                removeFromFavorites();
            }
        }

        // í˜„ì¬ ì •ë¥˜ì†Œ ì¦ê²¨ì°¾ê¸° ì¶”ê°€
        function addToFavorites() {
            if (!currentStopInfo) return;

            post(`/api/map/stop/favorite/${currentStopInfo.nodeId}`, null, function() {
                // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ê°±ì‹ 
                showFavoriteStopList();
            });
        }

        // í˜„ì¬ ì •ë¥˜ì†Œ ì¦ê²¨ì°¾ê¸° ì‚­ì œ
        function removeFromFavorites() {
            if (!currentStopInfo) return;

            doDelete(`/api/map/stop/favorite/${currentStopInfo.nodeId}`, function() {
                // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ê°±ì‹ 
                showFavoriteStopList();
            });
        }

        // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ê°€ì ¸ì™€ í‘œì‹œí•˜ê¸°
        function showFavoriteStopList() {
            get(`/api/map/stop/favorites`, function(favoriteStopList) {
                const favoritesElement = document.getElementById('favorites-list')

                favoritesElement.innerHTML = favoriteStopList.map((stopInfo) => {
                    favoriteStopInfos[stopInfo.nodeId] = stopInfo;

                    return `
                        <li onclick="clickFavoriteStop(${stopInfo.nodeId})">
                            ${stopInfo.nodeName}
                        </li>
                    `
                }).join('');
            });
        }

        // ì¦ê²¨ì°¾ê¸° ì •ë¥˜ì†Œ í´ë¦­ ì´ë²¤íŠ¸
        function clickFavoriteStop(nodeId) {
            const stopInfo = favoriteStopInfos[nodeId];

            // ì •ë³´íŒ¨ë„ í‘œì‹œ
            showBusStopInfo(stopInfo);

            // ìœ„ì¹˜ë¡œ ì´ë™
            map.panTo(new kakao.maps.LatLng(stopInfo.lat, stopInfo.lng));
        }

        // ë²„ìŠ¤ ìœ„ì¹˜ ì •ë³´ ì²˜ë¦¬ ì´ë²¤íŠ¸ ì„¤ì •(SSE)
        function setSseEvent() {
            const sse = new EventSource("/api/map/bus/pos");

            sse.onmessage = function(event) {
                const busPosInfoList = JSON.parse(event.data);

                // ê¸°ì¡´ ë²„ìŠ¤ ë§ˆì»¤ ì œê±°
                clearBusMarkers();

                busPosInfoList.forEach((busPosInfo) => {
                    var marker = createMarker(new kakao.maps.LatLng(busPosInfo.posY, busPosInfo.posX), 'bus', busPosInfo.plainNo);
                    marker.setMap(map);
                    busMarkers.push(marker);
                });
            };
        }

        // ë²„ìŠ¤ ìœ„ì¹˜ ë§ˆì»¤ ì „ë¶€ ì œê±°
        function clearBusMarkers() {
            busMarkers.forEach((marker) => marker.setMap(null));
            busMarkers = [];
        }

        // ë§ˆì»¤ í‘œì‹œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì´ë²¤íŠ¸
        function toggleMarkersButton() {
            const button = document.getElementById('marker-toggle-btn');
            markersVisible = !markersVisible;

            if (markersVisible) {
                button.classList.add('active');
                clusterer.addMarkers(stopMarkers);
            } else {
                button.classList.remove('active');
                clusterer.clear();
            }
        }
    </script>

</body>
</html>

